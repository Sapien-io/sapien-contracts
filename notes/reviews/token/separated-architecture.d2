title: "Separated Token & Vesting Architecture" {
  near: top-center
  style.font-size: 24
  style.bold: true
}

# Current Architecture (Problem)
current: "Current Monolithic Architecture" {
  style.fill: "#ffebee"
  style.stroke: "#d32f2f"
  style.stroke-width: 2
  
  sapien_token_current: "SapienToken (Current)" {
    style.fill: "#ffcdd2"
    
    erc20_logic: "ERC20 Logic" {
      style.fill: "#e8f5e8"
    }
    
    vesting_logic: "Vesting Logic" {
      style.fill: "#fff3e0"
      
      vesting_schedules: "VestingSchedule[]"
      release_tokens: "releaseTokens()"
      update_vesting: "updateVestingSchedule()"
      update_safe: "updateVestingSafe()"
    }
    
    upgrade_logic: "Upgrade Logic" {
      style.fill: "#f3e5f5"
    }
    
    access_control: "Access Control" {
      style.fill: "#e1f5fe"
    }
  }
  
  problems: "Problems" {
    style.fill: "#ffebee"
    style.stroke: "#d32f2f"
    
    violation: "• Violates Single Responsibility"
    security: "• Unnecessary Security Risk"
    trust: "• Lost Trust (Upgradeable Supply)"
    complexity: "• High Complexity"
  }
}

# Proposed Architecture (Solution)
proposed: "Proposed Separated Architecture" {
  style.fill: "#e8f5e8"
  style.stroke: "#388e3c"
  style.stroke-width: 2
  
  # Immutable Token Contract
  sapien_token_new: "SapienToken (New)" {
    style.fill: "#c8e6c9"
    style.stroke: "#2e7d32"
    style.stroke-width: 2
    
    immutable_label: "IMMUTABLE" {
      style.font-size: 12
      style.bold: true
      style.fill: "#1b5e20"
    }
    
    erc20_only: "Pure ERC20 Logic" {
      style.fill: "#a5d6a7"
      
      transfer: "transfer()"
      approve: "approve()"
      balance_of: "balanceOf()"
      total_supply: "totalSupply()"
    }
    
    basic_features: "Basic Features" {
      style.fill: "#a5d6a7"
      
      pausable: "Pausable"
      access_control_basic: "Basic Access Control"
      events: "Transfer Events"
    }
  }
  
  # Upgradeable Vesting Manager
  vesting_manager: "VestingManager" {
    style.fill: "#bbdefb"
    style.stroke: "#1976d2"
    style.stroke-width: 2
    
    upgradeable_label: "UPGRADEABLE" {
      style.font-size: 12
      style.bold: true
      style.fill: "#0d47a1"
    }
    
    vesting_core: "Vesting Core Logic" {
      style.fill: "#90caf9"
      
      schedules: "VestingSchedule[]"
      create_schedule: "createVestingSchedule()"
      update_schedule: "updateVestingSchedule()"
      release_tokens: "releaseTokens()"
    }
    
    allocation_types: "Allocation Management" {
      style.fill: "#90caf9"
      
      investors: "INVESTORS"
      team: "TEAM"
      trainer_comp: "TRAINER_COMP"
      airdrops: "AIRDROPS"
      foundation: "FOUNDATION_TREASURY"
      liquidity: "LIQUIDITY_INCENTIVES"
    }
    
    admin_functions: "Admin Functions" {
      style.fill: "#90caf9"
      
      update_safe: "updateVestingSafe()"
      emergency_pause: "pause()"
      upgrade_auth: "authorizeUpgrade()"
    }
  }
  
  # External Contracts
  gnosis_safe: "Gnosis Safe" {
    style.fill: "#f3e5f5"
    style.stroke: "#7b1fa2"
    
    multisig: "Multi-signature"
    admin_control: "Admin Control"
    token_custody: "Token Custody"
  }
  
  rewards_contract: "Rewards Contract" {
    style.fill: "#fff3e0"
    style.stroke: "#f57c00"
    
    claim_rewards: "claimReward()"
    distribute: "distribute()"
  }
  
  staking_contract: "Staking Contract" {
    style.fill: "#e0f2f1"
    style.stroke: "#00695c"
    
    stake: "stake()"
    unstake: "unstake()"
    rewards_calc: "calculateRewards()"
  }
}

# Relationships
sapien_token_new -> vesting_manager: "Token Transfers" {
  style.stroke: "#4caf50"
  style.stroke-width: 2
}

vesting_manager -> gnosis_safe: "Admin Control" {
  style.stroke: "#9c27b0"
  style.stroke-width: 2
}

gnosis_safe -> sapien_token_new: "Initial Mint & Control" {
  style.stroke: "#9c27b0"
  style.stroke-width: 2
}

vesting_manager -> rewards_contract: "Release Tokens" {
  style.stroke: "#ff9800"
  style.stroke-width: 2
}

sapien_token_new -> staking_contract: "Staking Operations" {
  style.stroke: "#009688"
  style.stroke-width: 2
}

sapien_token_new -> rewards_contract: "Reward Distribution" {
  style.stroke: "#ff9800"
  style.stroke-width: 2
}

# Benefits
benefits: "Benefits of Separation" {
  style.fill: "#e8f5e8"
  style.stroke: "#388e3c"
  
  security: "Enhanced Security" {
    style.fill: "#c8e6c9"
    
    immutable_supply: "• Immutable Token Supply"
    reduced_attack: "• Reduced Attack Surface"
    single_responsibility: "• Single Responsibility"
  }
  
  trust: "Increased Trust" {
    style.fill: "#c8e6c9"
    
    no_upgrade_token: "• Non-upgradeable Token"
    transparent: "• Transparent Vesting"
    predictable: "• Predictable Behavior"
  }
  
  flexibility: "Operational Flexibility" {
    style.fill: "#c8e6c9"
    
    upgrade_vesting: "• Upgradeable Vesting Logic"
    modular: "• Modular Architecture"
    maintainable: "• Easier Maintenance"
  }
}

# Implementation Flow
implementation: "Implementation Steps" {
  style.fill: "#fff3e0"
  style.stroke: "#f57c00"
  
  step1: "1. Deploy Immutable SapienToken" {
    style.fill: "#ffe0b2"
    
    pure_erc20: "• Pure ERC20 implementation"
    no_vesting: "• Remove all vesting logic"
    no_upgrade: "• No upgrade functionality"
  }
  
  step2: "2. Deploy VestingManager" {
    style.fill: "#ffe0b2"
    
    vesting_only: "• Vesting logic only"
    upgradeable: "• UUPS upgradeable"
    timelock_admin: "• Timelock admin control"
  }
  
  step3: "3. Configure Relationships" {
    style.fill: "#ffe0b2"
    
    token_ref: "• Set token reference in VestingManager"
    permissions: "• Configure permissions"
    initial_vesting: "• Setup initial vesting schedules"
  }
  
  step4: "4. Transfer Control" {
    style.fill: "#ffe0b2"
    
    gnosis_control: "• Transfer admin to Gnosis Safe"
    test_flows: "• Test all token flows"
    audit: "• Security audit"
  }
}

# Data Flow
data_flow: "Token Flow Examples" {
  style.fill: "#e1f5fe"
  style.stroke: "#0277bd"
  
  vesting_flow: "Vesting Release Flow" {
    style.fill: "#b3e5fc"
    
    flow_steps: "1. VestingManager.releaseTokens()\n2. Calculate vested amount\n3. Transfer from Gnosis Safe\n4. Update vesting schedule"
  }
  
  staking_flow: "Staking Flow" {
    style.fill: "#b3e5fc"
    
    flow_steps: "1. User approves SapienToken\n2. StakingContract.stake()\n3. Token transfer to staking\n4. Update staking records"
  }
  
  rewards_flow: "Rewards Flow" {
    style.fill: "#b3e5fc"
    
    flow_steps: "1. VestingManager releases to RewardsContract\n2. User claims rewards\n3. Token transfer to user"
  }
}

# Position elements
current -> proposed: {
  style.stroke: "#4caf50"
  style.stroke-width: 3
  label: "REFACTOR"
}

proposed -> benefits
proposed -> implementation
proposed -> data_flow 