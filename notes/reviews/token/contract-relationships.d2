title: "Contract Relationships: Before vs After Vesting Separation" {
  near: top-center
  style.font-size: 24
  style.bold: true
}

# BEFORE: Current Monolithic Architecture
before: "BEFORE: Current Architecture" {
  style.fill: "#ffebee"
  style.stroke: "#d32f2f"
  style.stroke-width: 3
  
  # Core Contracts
  sapien_token_current: "SapienToken" {
    style.fill: "#ffcdd2"
    style.stroke: "#c62828"
    style.stroke-width: 2
    
    erc20: "ERC20 Logic"
    vesting: "Vesting Logic" {
      style.fill: "#fff3e0"
    }
    upgrade: "UUPS Upgradeable" {
      style.fill: "#f3e5f5"
    }
  }
  
  sapien_staking: "SapienStaking" {
    style.fill: "#e0f2f1"
    style.stroke: "#00695c"
    
    staking_logic: "Staking Logic"
    signature_verify: "EIP-712 Signatures"
    upgrade_staking: "UUPS Upgradeable"
  }
  
  sapien_rewards: "SapienRewards" {
    style.fill: "#fff3e0"
    style.stroke: "#f57c00"
    
    rewards_logic: "Rewards Logic"
    signature_verify_rewards: "EIP-712 Signatures"
    upgrade_rewards: "UUPS Upgradeable"
  }
  
  gnosis_safe: "Gnosis Safe" {
    style.fill: "#f3e5f5"
    style.stroke: "#7b1fa2"
    
    multisig: "Multi-signature"
    admin_control: "Admin Control"
  }
  
  # External Users
  users: "Users" {
    style.fill: "#e8f5e8"
    style.stroke: "#388e3c"
  }
  
  # Relationships in current architecture
  gnosis_safe -> sapien_token_current: "Admin Control\n(pause, upgrade, vesting)" {
    style.stroke: "#9c27b0"
    style.stroke-width: 2
  }
  
  gnosis_safe -> sapien_staking: "Admin Control" {
    style.stroke: "#9c27b0"
    style.stroke-width: 2
  }
  
  gnosis_safe -> sapien_rewards: "Admin Control" {
    style.stroke: "#9c27b0"
    style.stroke-width: 2
  }
  
  sapien_token_current -> sapien_staking: "Token Transfers\n(stake/unstake)" {
    style.stroke: "#009688"
    style.stroke-width: 2
  }
  
  sapien_token_current -> sapien_rewards: "Token Transfers\n(rewards)" {
    style.stroke: "#ff9800"
    style.stroke-width: 2
  }
  
  sapien_rewards -> sapien_token_current: "releaseTokens()\n(vesting calls)" {
    style.stroke: "#ff5722"
    style.stroke-width: 2
    style.stroke-dash: 5
  }
  
  users -> sapien_staking: "Stake/Unstake" {
    style.stroke: "#4caf50"
    style.stroke-width: 2
  }
  
  users -> sapien_rewards: "Claim Rewards" {
    style.stroke: "#4caf50"
    style.stroke-width: 2
  }
  
  users -> sapien_token_current: "ERC20 Operations" {
    style.stroke: "#4caf50"
    style.stroke-width: 2
  }
  
  # Problems with current architecture - Vertical layout
  problems_current: "Current Problems" {
    style.fill: "#ffebee"
    style.stroke: "#d32f2f"
    direction: down
    
    mixed_concerns: "• Mixed Concerns in Token"
    upgrade_risk: "• Upgradeable Token Supply"
    complex_token: "• Complex Token Contract"
    trust_issues: "• Reduced Trust"
    
    mixed_concerns -> upgrade_risk
    upgrade_risk -> complex_token
    complex_token -> trust_issues
  }
}

# AFTER: Separated Architecture
after: "AFTER: Separated Architecture" {
  style.fill: "#e8f5e8"
  style.stroke: "#388e3c"
  style.stroke-width: 3
  
  # Core Contracts - Separated
  sapien_token_new: "SapienToken" {
    style.fill: "#c8e6c9"
    style.stroke: "#2e7d32"
    style.stroke-width: 2
    
    immutable_label: "IMMUTABLE" {
      style.font-size: 10
      style.bold: true
    }
    
    erc20_pure: "Pure ERC20 Logic"
    basic_features: "Basic Features Only"
  }
  
  vesting_vault: "VestingVault" {
    style.fill: "#bbdefb"
    style.stroke: "#1976d2"
    style.stroke-width: 2
    
    upgradeable_label: "UPGRADEABLE" {
      style.font-size: 10
      style.bold: true
    }
    
    vesting_pure: "Pure Vesting Logic"
    allocation_mgmt: "Allocation Management"
  }
  
  sapien_staking_new: "SapienStaking" {
    style.fill: "#e0f2f1"
    style.stroke: "#00695c"
    
    staking_logic_new: "Staking Logic"
    simplified_sigs: "Simplified Signatures"
    upgrade_staking_new: "UUPS Upgradeable"
  }
  
  sapien_rewards_new: "SapienRewards" {
    style.fill: "#fff3e0"
    style.stroke: "#f57c00"
    
    rewards_logic_new: "Rewards Logic"
    enhanced_security: "Enhanced Security"
    upgrade_rewards_new: "UUPS Upgradeable"
  }
  
  gnosis_safe_new: "Gnosis Safe" {
    style.fill: "#f3e5f5"
    style.stroke: "#7b1fa2"
    
    multisig_new: "Multi-signature"
    admin_control_new: "Admin Control"
  }
  
  # External Users
  users_new: "Users" {
    style.fill: "#e8f5e8"
    style.stroke: "#388e3c"
  }
  
  # Relationships in new architecture
  gnosis_safe_new -> vesting_vault: "Admin Control\n(vesting only)" {
    style.stroke: "#9c27b0"
    style.stroke-width: 2
  }
  
  vesting_vault -> sapien_staking_new: "Admin Control" {
    style.stroke: "#9c27b0"
    style.stroke-width: 2
  }
  
  vesting_vault -> sapien_rewards_new: "Admin Control" {
    style.stroke: "#9c27b0"
    style.stroke-width: 2
  }
  
  gnosis_safe_new -> sapien_token_new: "Basic Admin\n(pause only)" {
    style.stroke: "#9c27b0"
    style.stroke-width: 1
    style.stroke-dash: 5
  }
  
  vesting_vault -> sapien_token_new: "Token Transfers\n(vesting releases)" {
    style.stroke: "#2196f3"
    style.stroke-width: 2
  }
  
  sapien_token_new -> sapien_staking_new: "Token Transfers\n(stake/unstake)" {
    style.stroke: "#009688"
    style.stroke-width: 2
  }
  
  sapien_token_new -> sapien_rewards_new: "Token Transfers\n(rewards)" {
    style.stroke: "#ff9800"
    style.stroke-width: 2
  }
  
  vesting_vault -> sapien_rewards_new: "Release Tokens\n(direct funding)" {
    style.stroke: "#3f51b5"
    style.stroke-width: 2
  }
  
  users_new -> sapien_staking_new: "Stake/Unstake" {
    style.stroke: "#4caf50"
    style.stroke-width: 2
  }
  
  users_new -> sapien_rewards_new: "Claim Rewards" {
    style.stroke: "#4caf50"
    style.stroke-width: 2
  }
  
  users_new -> sapien_token_new: "ERC20 Operations" {
    style.stroke: "#4caf50"
    style.stroke-width: 2
  }
  
  # Benefits of new architecture - Vertical layout
  benefits_new: "Benefits Achieved" {
    style.fill: "#e8f5e8"
    style.stroke: "#388e3c"
    direction: down
    
    separation: "• Clear Separation of Concerns"
    immutable_token: "• Immutable Token Supply"
    modular: "• Modular Architecture"
    enhanced_trust: "• Enhanced Trust"
    flexible_vesting: "• Flexible Vesting Management"
    
    separation -> immutable_token
    immutable_token -> modular
    modular -> enhanced_trust
    enhanced_trust -> flexible_vesting
  }
}

# Key Changes Summary
changes: "Key Architectural Changes" {
  style.fill: "#fff3e0"
  style.stroke: "#f57c00"
  style.stroke-width: 2
  
  token_changes: "Token Contract" {
    style.fill: "#ffe0b2"
    
    removed: "REMOVED:\n• Vesting logic\n• Upgrade capability\n• Complex admin functions"
    kept: "KEPT:\n• Pure ERC20 functionality\n• Basic pause capability\n• Transfer controls"
  }
  
  vesting_changes: "New Vesting Vault" {
    style.fill: "#ffe0b2"
    
    added: "ADDED:\n• Dedicated vesting logic\n• Allocation management\n• Upgrade capability"
    benefits: "BENEFITS:\n• Focused responsibility\n• Enhanced security\n• Operational flexibility"
  }
  
  relationship_changes: "Relationship Changes" {
    style.fill: "#ffe0b2"
    
    before_rel: "BEFORE:\n• Token handles vesting\n• Rewards calls token\n• Complex dependencies"
    after_rel: "AFTER:\n• VestingVault handles vesting\n• Direct token transfers\n• Clear dependencies"
  }
}

# Flow Comparison
flow_comparison: "Token Flow Comparison" {
  style.fill: "#e1f5fe"
  style.stroke: "#0277bd"
  
  before_flow: "Before: Vesting Flow" {
    style.fill: "#b3e5fc"
    
    steps_before: "1. RewardsContract.releaseTokens()\n2. SapienToken.releaseTokens()\n3. Calculate vested amount\n4. Transfer from Gnosis Safe\n5. Update vesting schedule"
  }
  
  after_flow: "After: Vesting Flow" {
    style.fill: "#b3e5fc"
    
    steps_after: "1. VestingVault.releaseTokens()\n2. Calculate vested amount\n3. Transfer via SapienToken\n4. Update vesting schedule\n5. Direct funding to contracts"
  }
}

# Position elements for better layout
before -> after: "REFACTOR" {
  style.stroke: "#4caf50"
  style.stroke-width: 4
  style.font-size: 16
  style.bold: true
}

after -> changes
after -> flow_comparison 