# SapienStaking Contract Flow

# Main Components
User: User
Signer: {
  shape: person
  label: "Sapien Signer"
}
GnosisSafe: {
  shape: cylinder
  label: "Gnosis Safe\n(Admin)"
}
SapienStaking: {
  shape: rectangle
  label: "SapienStaking Contract"
  
  state: {
    shape: rectangle
    label: "State"
    style.multiple: true
    
    TokenStorage: "- _sapienToken: ERC20Upgradeable\n- _sapienAddress: address\n- _gnosisSafe: address"
    StakingState: "- stakers: mapping\n- totalStaked: uint256\n- usedOrders: mapping"
    Constants: "- MINIMUM_STAKE: 1000 tokens\n- Multipliers (1.05x - 1.50x)\n- COOLDOWN_PERIOD: 2 days\n- EARLY_WITHDRAWAL_PENALTY: 20%"
  }
  
  publicFunctions: {
    shape: rectangle
    label: "Public Functions"
    style.multiple: true
    
    stake: "stake(amount, lockUpPeriod, orderId, signature)"
    initiateUnstake: "initiateUnstake(amount, newOrderId, stakeOrderId, signature)"
    unstake: "unstake(amount, newOrderId, stakeOrderId, signature)"
    instantUnstake: "instantUnstake(amount, newOrderId, stakeOrderId, signature)"
  }
  
  adminFunctions: {
    shape: rectangle
    label: "Admin Functions"
    style.multiple: true
    
    initialize: "initialize(sapienToken, sapienAddress, gnosisSafe)"
    authorizeUpgrade: "authorizeUpgrade(newImplementation)"
    transferOwnership: "transferOwnership(newOwner)"
    pause: "pause()"
    unpause: "unpause()"
  }
  
  internalFunctions: {
    shape: rectangle
    label: "Internal Functions"
    style.multiple: true
    
    verifyOrder: "verifyOrder(userWallet, amount, orderId, actionType, signature)"
    calculateMultiplier: "calculateMultiplier(lockUpPeriod)"
    markOrderAsUsed: "_markOrderAsUsed(orderId)"
  }
}

SapienToken: {
  shape: cylinder
  label: "Sapien Token\n(ERC20Upgradeable)"
}

# Flow Diagrams
User -> SapienStaking.publicFunctions.stake: "1. Request stake"
SapienStaking.publicFunctions.stake -> SapienStaking.internalFunctions.verifyOrder: "2. Verify signature"
SapienStaking.internalFunctions.verifyOrder -> Signer: "3. Check if signed by authorized signer"
SapienStaking.publicFunctions.stake -> SapienToken: "4. Transfer tokens from user"
SapienStaking.publicFunctions.stake -> SapienStaking.internalFunctions.calculateMultiplier: "5. Calculate multiplier"
SapienStaking.publicFunctions.stake -> SapienStaking.state.StakingState: "6. Store staking info"

User -> SapienStaking.publicFunctions.initiateUnstake: "1. Request unstake initiation"
SapienStaking.publicFunctions.initiateUnstake -> SapienStaking.internalFunctions.verifyOrder: "2. Verify signature"
SapienStaking.publicFunctions.initiateUnstake -> SapienStaking.state.StakingState: "3. Set cooldown start & amount"

User -> SapienStaking.publicFunctions.unstake: "1. Complete unstake after cooldown"
SapienStaking.publicFunctions.unstake -> SapienStaking.internalFunctions.verifyOrder: "2. Verify signature"
SapienStaking.publicFunctions.unstake -> SapienToken: "3. Transfer tokens to user"
SapienStaking.publicFunctions.unstake -> SapienStaking.state.StakingState: "4. Update staking position"

User -> SapienStaking.publicFunctions.instantUnstake: "1. Request instant unstake (with penalty)"
SapienStaking.publicFunctions.instantUnstake -> SapienStaking.internalFunctions.verifyOrder: "2. Verify signature"
SapienStaking.publicFunctions.instantUnstake -> SapienToken: "3a. Transfer tokens to user (minus penalty)"
SapienStaking.publicFunctions.instantUnstake -> GnosisSafe: "3b. Transfer penalty to Gnosis Safe"
SapienStaking.publicFunctions.instantUnstake -> SapienStaking.state.StakingState: "4. Update staking position"

GnosisSafe -> SapienStaking.adminFunctions: "Administer contract"

# Staking Flow
stakingFlow: {
  direction: right
  
  user: User
  contract: "SapienStaking"
  signer: "Sapien Signer"
  token: "SapienToken"
  
  user -> signer: "1. Request signature for stake action"
  signer -> user: "2. Provide signed approval"
  user -> contract: "3. Call stake() with signed approval"
  contract -> token: "4. Transfer tokens from user"
  contract -> contract: "5. Store stake details"
  contract -> user: "6. Emit Staked event"
}

# Unstaking Flow
unstakingFlow: {
  direction: right
  
  user: User
  contract: "SapienStaking"
  signer: "Sapien Signer"
  token: "SapienToken"
  
  user -> signer: "1. Request signature for initiateUnstake"
  signer -> user: "2. Provide signed approval"
  user -> contract: "3. Call initiateUnstake()"
  contract -> contract: "4. Start cooldown period"
  contract -> user: "5. Emit UnstakingInitiated event"
  
  user -> signer: "6. After cooldown, request signature for unstake"
  signer -> user: "7. Provide signed approval"
  user -> contract: "8. Call unstake()"
  contract -> token: "9. Transfer tokens to user"
  contract -> user: "10. Emit Unstaked event"
}

# Instant Unstaking Flow
instantUnstakingFlow: {
  direction: right
  
  user: User
  contract: "SapienStaking"
  signer: "Sapien Signer"
  token: "SapienToken"
  safe: "Gnosis Safe"
  
  user -> signer: "1. Request signature for instantUnstake"
  signer -> user: "2. Provide signed approval"
  user -> contract: "3. Call instantUnstake()"
  contract -> contract: "4. Calculate penalty (20%)"
  contract -> token: "5a. Transfer tokens minus penalty to user"
  contract -> safe: "5b. Transfer penalty to Gnosis Safe"
  contract -> user: "6. Emit InstantUnstake event"
} 